<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Interaction</title>
    <link rel="stylesheet" href="styles.css">
    <script src="load-nav.js"></script>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        form {
            margin-top: 20px;
        }
        input[type="text"], input[type="email"] {
            width: 100%;
            padding: 5px;
            margin: 5px 0;
        }
        button {
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .pagination button {
            margin: 0 5px;
        }
        .search-container {
            margin-bottom: 20px;
        }
        .error-message {
            color: red;
            margin-top: 10px;
        }
        .success-message {
            color: green;
            margin-top: 10px;
        }
        @media (max-width: 600px) {
            table, tr, td {
                display: block;
            }
            th {
                display: none;
            }
            tr {
                margin-bottom: 10px;
            }
            td {
                border: none;
                position: relative;
                padding-left: 50%;
            }
            td:before {
                content: attr(data-label);
                position: absolute;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                font-weight: bold;
            }
        }
    </style>
</head>
<body>
    <section>
        <h1>Database Interaction</h1>
        
        <h2>Add New User</h2>
        <form id="addUserForm">
            <input type="text" id="name" placeholder="Name" required>
            <input type="email" id="email" placeholder="Email" required>
            <input type="number" id="height" placeholder="Height (cm)">
            <input type="number" id="weight" placeholder="Weight (kg)">
            <input type="number" id="age" placeholder="Age">
            <input type="text" id="nationality" placeholder="Nationality">
            <input type="text" id="occupation" placeholder="Occupation">
            <input type="text" id="education" placeholder="Education">
            <input type="text" id="hobbies" placeholder="Hobbies (comma-separated)">
            <input type="text" id="favoriteColor" placeholder="Favorite Color">
            <label for="gender">Gender:</label>
            <select id="gender" required>
                <option value="">Select Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
                <option value="Prefer not to say">Prefer not to say</option>
            </select>
            <button type="button" id="randomizeButton">Randomize Fields</button>
            <button type="submit">Add User</button>
        </form>
        <div id="message"></div>

        <h2>User List</h2>
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search users...">
            <select id="searchField">
                <option value="all">All Fields</option>
                <option value="name">Name</option>
                <option value="email">Email</option>
                <option value="height">Height</option>
                <option value="weight">Weight</option>
                <option value="age">Age</option>
                <option value="nationality">Nationality</option>
                <option value="occupation">Occupation</option>
                <option value="education">Education</option>
                <option value="hobbies">Hobbies</option>
                <option value="favoriteColor">Favorite Color</option>
            </select>
            <button onclick="searchUsers()">Search</button>
        </div>
        <table id="userTable">
            <thead>
                <tr>
                    <th onclick="sortUsers('name')">Name</th>
                    <th onclick="sortUsers('email')">Email</th>
                    <th onclick="sortUsers('height')">Height</th>
                    <th onclick="sortUsers('weight')">Weight</th>
                    <th onclick="sortUsers('age')">Age</th>
                    <th onclick="sortUsers('nationality')">Nationality</th>
                    <th onclick="sortUsers('occupation')">Occupation</th>
                    <th onclick="sortUsers('education')">Education</th>
                    <th>Hobbies</th>
                    <th onclick="sortUsers('favoriteColor')">Favorite Color</th>
                    <th onclick="sortUsers('createdAt')">Created At</th>
                    <th onclick="sortUsers('gender')">Gender</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="userTableBody">
            </tbody>
        </table>
        <div class="pagination" id="pagination"></div>
    </section>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        let currentSort = { field: 'createdAt', order: 'desc' };
        let searchTerm = '';
        let limit = 10; // Add this line

        // Function to fetch and display users
        async function fetchUsers(page = 1) {
            try {
                const response = await fetch(`/api/users?page=${page}&limit=${limit}&sort=${currentSort.field}&order=${currentSort.order}&search=${searchTerm}`);
                const data = await response.json();
                const users = data.users;
                currentPage = data.currentPage;
                totalPages = data.totalPages;
                const tableBody = document.getElementById('userTableBody');
                tableBody.innerHTML = '';
                users.forEach(user => {
                    const row = `
                        <tr>
                            <td data-label="Name">${user.name}</td>
                            <td data-label="Email">${user.email}</td>
                            <td data-label="Height">${user.height || ''}</td>
                            <td data-label="Weight">${user.weight || ''}</td>
                            <td data-label="Age">${user.age || ''}</td>
                            <td data-label="Nationality">${user.nationality || ''}</td>
                            <td data-label="Occupation">${user.occupation || ''}</td>
                            <td data-label="Education">${user.education || ''}</td>
                            <td data-label="Hobbies">${user.hobbies ? user.hobbies.join(', ') : ''}</td>
                            <td data-label="Favorite Color">${user.favoriteColor || ''}</td>
                            <td data-label="Created At">${new Date(user.createdAt).toLocaleString()}</td>
                            <td data-label="Gender">${user.gender || ''}</td>
                            <td data-label="Actions">
                                <button onclick="editUser('${user._id}', this)">Edit</button>
                                <button onclick="deleteUser('${user._id}')">Delete</button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
                updatePagination();
            } catch (error) {
                console.error('Error fetching users:', error);
                showMessage('Error fetching users. Please try again.', 'error');
            }
        }

        // Function to add a new user
        async function addUser(event) {
            event.preventDefault();
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const height = document.getElementById('height').value;
            const weight = document.getElementById('weight').value;
            const age = document.getElementById('age').value;
            const nationality = document.getElementById('nationality').value;
            const occupation = document.getElementById('occupation').value;
            const education = document.getElementById('education').value;
            const hobbies = document.getElementById('hobbies').value.split(',').map(hobby => hobby.trim());
            const favoriteColor = document.getElementById('favoriteColor').value;
            const gender = document.getElementById('gender').value;
            
            if (!validateForm()) {
                return;
            }

            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name, email, height, weight, age, nationality, occupation, education, hobbies, favoriteColor, gender }),
                });
                if (response.ok) {
                    document.getElementById('addUserForm').reset();
                    fetchUsers();
                    showMessage('User added successfully', 'success');
                } else {
                    const errorData = await response.json();
                    showMessage(`Error adding user: ${errorData.message}`, 'error');
                }
            } catch (error) {
                console.error('Error adding user:', error);
                showMessage('Error adding user. Please try again.', 'error');
            }
        }

        // Function to update a user
        async function updateUser(id, userData) {
            try {
                const response = await fetch(`/api/users/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData),
                });
                if (response.ok) {
                    fetchUsers(currentPage);
                    showMessage('User updated successfully', 'success');
                } else {
                    const errorData = await response.json();
                    showMessage(`Error updating user: ${errorData.message}`, 'error');
                }
            } catch (error) {
                console.error('Error updating user:', error);
                showMessage('Error updating user. Please try again.', 'error');
            }
        }

        // Function to delete a user
        async function deleteUser(id) {
            if (confirm('Are you sure you want to delete this user?')) {
                try {
                    const response = await fetch(`/api/users/${id}`, {
                        method: 'DELETE',
                    });
                    if (response.ok) {
                        fetchUsers(currentPage);
                        showMessage('User deleted successfully', 'success');
                    } else {
                        const errorData = await response.json();
                        showMessage(`Error deleting user: ${errorData.message}`, 'error');
                    }
                } catch (error) {
                    console.error('Error deleting user:', error);
                    showMessage('Error deleting user. Please try again.', 'error');
                }
            }
        }

        // Function to edit user in-place
        function editUser(id, button) {
            const row = button.closest('tr');
            const cells = row.cells;
            const fields = ['name', 'email', 'height', 'weight', 'age', 'nationality', 'occupation', 'education', 'hobbies', 'favoriteColor', 'gender'];
            
            fields.forEach((field, index) => {
                const value = cells[index].textContent;
                cells[index].innerHTML = `<input type="${field === 'email' ? 'email' : 'text'}" value="${value}">`;
            });

            button.textContent = 'Save';
            button.onclick = function() { saveUser(id, this); };
        }

        // Function to save edited user
        function saveUser(id, button) {
            const row = button.closest('tr');
            const cells = row.cells;
            const fields = ['name', 'email', 'height', 'weight', 'age', 'nationality', 'occupation', 'education', 'hobbies', 'favoriteColor', 'gender'];
            const userData = {};

            fields.forEach((field, index) => {
                userData[field] = cells[index].querySelector('input').value;
            });

            userData.hobbies = userData.hobbies.split(',').map(hobby => hobby.trim());
            updateUser(id, userData);
            button.textContent = 'Edit';
            button.onclick = function() { editUser(id, this); };
        }

        // Function to update pagination
        function updatePagination() {
            const paginationDiv = document.getElementById('pagination');
            paginationDiv.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.onclick = () => fetchUsers(i);
                if (i === currentPage) {
                    button.disabled = true;
                }
                paginationDiv.appendChild(button);
            }
        }

        // Function to sort users
        function sortUsers(field) {
            if (currentSort.field === field) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.order = 'asc';
            }
            fetchUsers();
        }

        // Function to search users
        async function searchUsers() {
            const searchTerm = document.getElementById('searchInput').value;
            const searchField = document.getElementById('searchField').value;
            try {
                const response = await fetch(`/api/users?search=${searchTerm}&field=${searchField}&page=1&limit=${limit}&sort=${currentSort.field}&order=${currentSort.order}`);
                if (response.ok) {
                    const data = await response.json();
                    displayUsers(data.users);
                    updatePagination(data.currentPage, data.totalPages);
                } else {
                    showMessage('Error searching users', 'error');
                }
            } catch (error) {
                console.error('Error searching users:', error);
                showMessage('Error searching users', 'error');
            }
        }

        // Function to show messages
        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
            setTimeout(() => {
                messageDiv.textContent = '';
                messageDiv.className = '';
            }, 3000);
        }

        // Add event listener for form submission
        document.getElementById('addUserForm').addEventListener('submit', addUser);

        // Fetch users when the page loads
        fetchUsers();

        // Add this function
        function validateForm() {
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            let isValid = true;

            if (name.trim() === '') {
                showMessage('Name is required', 'error');
                isValid = false;
            }

            if (email.trim() === '') {
                showMessage('Email is required', 'error');
                isValid = false;
            } else if (!/\S+@\S+\.\S+/.test(email)) {
                showMessage('Email is invalid', 'error');
                isValid = false;
            }

            return isValid;
        }

        // Add this function near the end of your script section
        async function randomizeFields() {
            try {
                const response = await fetch('/api/generate-random-user');
                if (response.ok) {
                    const userData = await response.json();
                    document.getElementById('name').value = userData.name || '';
                    document.getElementById('email').value = userData.email || '';
                    document.getElementById('height').value = userData.height || '';
                    document.getElementById('weight').value = userData.weight || '';
                    document.getElementById('age').value = userData.age || '';
                    document.getElementById('nationality').value = userData.nationality || '';
                    document.getElementById('occupation').value = userData.occupation || '';
                    document.getElementById('education').value = userData.education || '';
                    document.getElementById('hobbies').value = Array.isArray(userData.hobbies) ? userData.hobbies.join(', ') : '';
                    document.getElementById('favoriteColor').value = userData.favoriteColor || '';
                    document.getElementById('gender').value = userData.gender || '';
                } else {
                    const errorData = await response.json();
                    console.error('Error generating random user data:', errorData);
                    showMessage(`Error generating random user data: ${errorData.error}`, 'error');
                }
            } catch (error) {
                console.error('Error generating random user data:', error);
                showMessage('Error generating random user data. Please try again.', 'error');
            }
        }

        // Add this event listener after your existing ones
        document.getElementById('randomizeButton').addEventListener('click', randomizeFields);

        function displayUsers(users) {
            const tableBody = document.getElementById('userTableBody');
            tableBody.innerHTML = '';
            users.forEach(user => {
                const row = `
                    <tr>
                        <td data-label="Name">${user.name}</td>
                        <td data-label="Email">${user.email}</td>
                        <td data-label="Height">${user.height || ''}</td>
                        <td data-label="Weight">${user.weight || ''}</td>
                        <td data-label="Age">${user.age || ''}</td>
                        <td data-label="Nationality">${user.nationality || ''}</td>
                        <td data-label="Occupation">${user.occupation || ''}</td>
                        <td data-label="Education">${user.education || ''}</td>
                        <td data-label="Hobbies">${user.hobbies ? user.hobbies.join(', ') : ''}</td>
                        <td data-label="Favorite Color">${user.favoriteColor || ''}</td>
                        <td data-label="Created At">${new Date(user.createdAt).toLocaleString()}</td>
                        <td data-label="Gender">${user.gender || ''}</td>
                        <td data-label="Actions">
                            <button onclick="editUser('${user._id}', this)">Edit</button>
                            <button onclick="deleteUser('${user._id}')">Delete</button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }
    </script>
</body>
</html>